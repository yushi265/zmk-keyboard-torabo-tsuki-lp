# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリでコードを操作する際のガイダンスを提供します。

## プロジェクト概要

これは、トラックボール対応の分割キーボードである Torabo Tsuki LP キーボード用の ZMK（Zephyr ベースの機械式キーボード）ファームウェア設定です。プロジェクトは Zephyr RTOS と West ビルドシステムを使用しています。

## ビルドシステム

プロジェクトはファームウェアのビルドに West（Zephyr のメタツール）を使用します：

- **ビルド設定**: `build.yaml` が異なる設定の複数のビルドターゲットを定義
- **依存関係**: `config/west.yml` が ZMK と sekigon-gonnoc の追加コンポーネントを指定
- **ビルドコマンド**: `west build` を使用（適切な West/Zephyr 環境設定が必要）

## ファームウェアバリアント

ビルドは異なる用途向けに複数のファームウェアファイルを生成します：
- `*_central`: トラックボール付きの側用（メイン/セントラルデバイスとして動作）
- `*_peripheral`: 反対側用（セントラルに接続）
- `*_double_ball_*`: デュアルトラックボール設定用
- 分割キーボードの各側用の左右バリアント

## コードアーキテクチャ

### ハードウェア設定
- **Device Tree**: `boards/shields/torabo_tsuki_lp/` のハードウェア定義
  - `torabo_tsuki_lp.dtsi`: GPIO マトリックス、トラックボール（PAW3222）、LED を含むメインハードウェア設定
  - `*_left.overlay` / `*_right.overlay`: 側面固有の設定
  - `torabo_tsuki_lp_layouts.dtsi`: 物理レイアウト定義
- **Matrix transforms**: 異なるキー数の複数のレイアウト（S、L サイズ）
- **トラックボール**: SPI 接続の PAW3222 センサー

### キーマップ
- **メインキーマップ**: `config/keymap.keymap`（シールドキーマップから参照）
- **5レイヤー**: ベースレイヤー + 記号、数字、マウス、ナビゲーション用の4つの追加レイヤー
  - **レイヤー3**: トラックボールスクロールモード（マウス移動がスクロール操作に切り替わる）
- **コンボ**: レイヤー上で定義されたBluetooth クリアコンボ

### 電源管理
- **分割電源管理**: `src/board.c` がインテリジェントな電力スケーリングを実装
- **4つの電源モード**: Active、Sleep1、Sleep2、Sleep3 で異なる BLE 接続間隔
- **アクティビティ検出**: キー押下またはトラックボール移動でアクティブモードにリセット
- **USB 電源認識**: USB 接続時はアクティブモードを維持

### ハードウェア機能
- **分割キーボード**: セントラル/ペリフェラル BLE 通信
- **トラックボール**: 電源管理付き PAW3222 光学センサー
- **ステータス LED**: GPIO 制御ステータス表示
- **非LiPo バッテリー**: 非リチウムバッテリー用カスタムバッテリー管理
- **ブートローダートリガー**: CDC ACM ブートローダーアクティベーションサポート

## 主要ファイル

- `config/keymap.keymap`: メインキーマップ設定
- `boards/shields/torabo_tsuki_lp/torabo_tsuki_lp.dtsi`: ハードウェア設定
- `src/board.c`: 分割電源管理とトラックボール統合
- `build.yaml`: 全ファームウェアバリアント用ビルド設定
- `config/west.yml`: 依存関係と ZMK バージョン仕様

## 開発ノート

- キーマップは keymap-editor と zmk-studio で編集可能
- 複数の物理レイアウトをサポート（S と L サイズ）
- トラックボールリスナーが電源管理用の入力イベントを処理
- BLE 接続パラメータはアクティビティに基づいて動的に調整